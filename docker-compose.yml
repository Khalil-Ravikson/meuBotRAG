version: '3.8'

services:
  # --- 1. WHATSAPP ENGINE ---
  waha:
    image: devlikeapro/waha
    container_name: waha
    restart: always
    ports:
      - "3000:3000"
    environment:
      - WHATSAPP_DEFAULT_ENGINE=NOWEB
      - WAHA_API_KEY=${WAHA_API_KEY}
      - WAHA_DASHBOARD_USERNAME=admin
      - WAHA_DASHBOARD_PASSWORD=${WAHA_DASHBOARD_PASS}
    volumes:
      - ./waha-data:/app/.sessions

  # --- 2. BANCO DE DADOS VETORIAL ---
  db:
    image: pgvector/pgvector:pg16
    container_name: vectordb
    restart: always
    environment:
      - POSTGRES_USER=${DB_USER}
      - POSTGRES_PASSWORD=${DB_PASS}
      - POSTGRES_DB=${DB_NAME}  
    ports:                    
      - "5433:5432"
    volumes:
      - ./pg-data-v3:/var/lib/postgresql/data

    # Não expus a porta 5432 para o host para evitar conflitos,
    # a comunicação é interna via rede Docker.
  redis:
    image: redis:alpine
    container_name: redis-cache
    restart: always
    ports:
      - "6379:6379"

  # --- 3. SEU BOT INTELIGENTE ---
  bot:
    build: .
    container_name: bot-rag
    restart: always
    depends_on:
      - waha
      - db # Espera o banco iniciar
      - redis # <--- O Bot agora espera o Redis ligar
    ports:
      - "8000:8000" # Porta para o Ngrok
    volumes:
      - .:/app
      - ./src:/app/src     # Hot-reload
      - ./dados:/app/dados # Acesso ao PDF
    environment:
      - GROQ_API_KEY=${GROQ_API_KEY}
      - WAHA_API_KEY=${WAHA_API_KEY}
      # URL interna do Docker para o WAHA
      - WAHA_BASE_URL=${WAHA_BASE_URL}
      # URL interna do Docker para o Banco
      - DATABASE_URL=postgresql+psycopg://${DB_USER}:${DB_PASS}@db:5432/${DB_NAME}
          
      - REDIS_URL=${REDIS_URL}
      - LLAMA_CLOUD_API_KEY=${LLAMA_CLOUD_API_KEY}