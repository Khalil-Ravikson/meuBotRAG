version: '3.8'

# =============================================================================
# COMO O .env FUNCIONA NESTE ARQUIVO
# =============================================================================
#
# O Docker Compose l√™ o .env automaticamente ‚Äî voc√™ n√£o precisa fazer nada.
# Ele serve para DUAS coisas diferentes ao mesmo tempo:
#
#  1) Interpola√ß√£o no docker-compose.yml ‚Üí ${VARIAVEL}
#     Antes de subir os containers, o Compose substitui ${DB_USER} pelo valor
#     que est√° no seu .env. Por isso DATABASE_URL pode ser montada dinamicamente.
#
#  2) Inje√ß√£o dentro do container ‚Üí env_file: .env
#     O arquivo .env completo √© passado para DENTRO do container como vari√°veis
#     de ambiente. √â isso que permite o settings.py ler GROQ_API_KEY etc.
#
# POR QUE ALGUMAS VARI√ÅVEIS APARECEM EM `environment:` E N√ÉO S√ì NO `env_file:`?
#
#   DATABASE_URL, REDIS_URL e EVOLUTION_BASE_URL usam NOMES DE SERVI√áO Docker
#   (db, redis, evolution-api) como host ‚Äî n√£o "localhost".
#   O .env do seu computador tem "localhost" (para dev local sem Docker).
#   Por isso sobrescrevemos essas tr√™s aqui para o ambiente Docker correto.
#
# O env_file: passa tudo que restou (GROQ_API_KEY, HF_TOKEN, etc.)
# =============================================================================

services:
  # ---------------------------------------------------------------------------
  # 1. Evolution API v2 ‚Äî Novo Motor do WhatsApp
  # ---------------------------------------------------------------------------
  evolution-api:
    image: atendai/evolution-api:v2.1.1
    container_name: evolution_api
    restart: unless-stopped
    ports:
      - "8080:8080"
    environment:
      - SERVER_URL=http://localhost:8080
      - AUTHENTICATION_API_KEY=${EVOLUTION_API_KEY}
      # üëá Configura√ß√µes de Banco de Dados (usando o seu pgvector)
      - DATABASE_PROVIDER=postgresql
      - DATABASE_CONNECTION_URI=postgresql://${DB_USER}:${DB_PASS}@db:5432/${DB_NAME}?schema=evolution
      - DATABASE_CONNECTION_CLIENT_NAME=evolution_api
      # üëá Configura√ß√µes de Cache (usando o seu Redis)
      - CACHE_REDIS_ENABLED=true
      - CACHE_REDIS_URI=redis://redis:6379/1
      - CACHE_REDIS_PREFIX_KEY=evolution
      # üëá Webhook
      - WEBHOOK_GLOBAL_URL=http://bot-rag:8000/webhook
      - WEBHOOK_GLOBAL_ENABLED=true
      - WEBHOOK_EVENTS_MESSAGES_UPSERT=true
      - CONFIG_SESSION_PHONE_VERSION=2.3000.1032691661
      
    volumes:
      - ./evolution_instances:/evolution/instances
    healthcheck:
      test: ["CMD-SHELL", "wget -qO- http://localhost:8080/ || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 15s

  # ---------------------------------------------------------------------------
  # 2. pgvector ‚Äî Banco de dados vetorial (PostgreSQL + extens√£o pgvector)
  # ---------------------------------------------------------------------------
  db:
    image: pgvector/pgvector:pg16
    container_name: vectordb
    restart: unless-stopped
    environment:
      - POSTGRES_USER=${DB_USER}
      - POSTGRES_PASSWORD=${DB_PASS}
      - POSTGRES_DB=${DB_NAME}
    ports:
      - "5433:5432"     # porta 5433 no host para n√£o conflitar com Postgres local
    volumes:
      - ./pg-data-v3:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${DB_USER} -d ${DB_NAME}"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s

  # ---------------------------------------------------------------------------
  # 3. Redis ‚Äî Hist√≥rico de conversas + cache + deduplica√ß√£o
  # ---------------------------------------------------------------------------
  redis:
    image: redis:alpine
    container_name: redis-cache
    restart: unless-stopped
    ports:
      - "6379:6379"
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 3

  # ---------------------------------------------------------------------------
  # 4. Bot RAG ‚Äî A aplica√ß√£o principal
  # ---------------------------------------------------------------------------
  bot:
    build: .
    container_name: bot-rag
    restart: unless-stopped

    # `condition: service_healthy` significa que o bot s√≥ inicia depois que
    # db e redis passarem no healthcheck ‚Äî resolve o erro de conex√£o no startup
    depends_on:
      db:
        condition: service_healthy
      redis:
        condition: service_healthy
      evolution-api:
        condition: service_started   # Agora espera a Evolution API iniciar

    ports:
      - "8000:8000"

    volumes:
      - ./dados:/app/dados           # PDFs para ingest√£o (sempre necess√°rio)
      - ./src:/app/src               # hot-reload em desenvolvimento
      # Em produ√ß√£o: remova a linha acima e reconstrua a imagem com `docker-compose build`

    # ‚îÄ‚îÄ env_file: injeta o .env inteiro dentro do container ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    # O settings.py (pydantic-settings) l√™ as vari√°veis daqui.
    # Tudo que n√£o for sobrescrito em `environment:` vem do .env.
    env_file:
      - .env

    # ‚îÄ‚îÄ environment: sobrescreve apenas o que muda no ambiente Docker ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    # Hosts s√£o nomes de servi√ßos Docker, n√£o "localhost".
    # Estas tr√™s linhas sobrescrevem o que veio do env_file acima.
    environment:
      - DATABASE_URL=postgresql+psycopg://${DB_USER}:${DB_PASS}@db:5432/${DB_NAME}
      - REDIS_URL=redis://redis:6379/0
      # üëá Atualizado para Evolution API
      - EVOLUTION_BASE_URL=http://evolution-api:8080
      - WHATSAPP_HOOK_URL=http://bot-rag:8000/webhook

    healthcheck:
      test: ["CMD-SHELL", "curl -sf http://localhost:8000/health || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 90s  # tempo para ingest√£o de PDFs no startup